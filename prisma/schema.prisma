generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  id     Int     @id @default(autoincrement())
  shopId BigInt  @unique
  region String?
  status String  @default("UNKNOWN")

  tokens OAuthToken?
  orders Order[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model OAuthToken {
  id     Int  @id @default(autoincrement())
  shopId Int  @unique
  shop   Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  accessToken           String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshToken          String?   @db.Text
  refreshTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id Int @id @default(autoincrement())

  shopId Int
  shop   Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  orderSn     String
  orderStatus String?
  region      String?
  currency    String?

  daysToShip Int?
  shipByDate DateTime?

  shopeeCreateTime DateTime?
  shopeeUpdateTime DateTime?

  bookingSn             String?
  cod                   Boolean?
  advancePackage        Boolean?
  hotListingOrder       Boolean?
  isBuyerShopCollection Boolean?
  messageToSeller       String?  @db.Text

  reverseShippingFee Int?

  addressSnapshots OrderAddressSnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, orderSn])
  @@index([shopId, orderStatus])
  @@index([shopId, shipByDate])
}

model OrderAddressSnapshot {
  id Int @id @default(autoincrement())

  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  name        String?
  phone       String?
  town        String?
  district    String?
  city        String?
  state       String?
  region      String?
  zipcode     String?
  fullAddress String? @db.Text

  addressHash String

  createdAt DateTime @default(now())

  @@index([orderId, createdAt])
  @@index([addressHash])
}

model Product {
  id Int @id @default(autoincrement())

  shopId Int
  shop   Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  itemId      BigInt
  status      String?
  title       String?
  description String?  @db.Text
  ratingStar  Float?
  ratingCount Int?
  currency    String?
  priceMin    Int?
  priceMax    Int?
  itemSku     String?
  stock       Int?
  sold        Int?
  attributes  Json?
  hasModel    Boolean?
  brand       String?
  categoryId  BigInt?

  shopeeCreateTime DateTime?
  shopeeUpdateTime DateTime?

  images ProductImage[]
  models ProductModel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, itemId])
  @@index([shopId, status])
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url     String
  imageId String? // <- novo: o id retornado pelo upload

  @@index([productId])
}

model ProductModel {
  id Int @id @default(autoincrement())

  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  modelId          BigInt
  name             String?
  sku              String?
  price            Int?
  stock            Int?
  sold             Int?
  ratingStar       Float?
  ratingCount      Int?
  shopeeCreateTime DateTime?

  @@unique([productId, modelId])
  @@index([productId])
}
